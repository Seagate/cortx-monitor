#!/bin/bash

set -e -u -o pipefail

#################################################################
# This script performs following operations
# - Check if product is one of the enabled products
# - Configures role in sspl.conf if supplied
# - Executes sspl_reinit script
# - If product name ECS and cluster nodes are passed in arguments,
#   cluster_nodes key in consul will be updated.
# - If ECS only passed and already two node names present in
#   cluster, rabbitmq service will not be started on 3rd node
#################################################################

script_dir=$(dirname $0)

# Import common constants
source $script_dir/constants.sh

SCRIPT_NAME=$(basename $0)
DIR_NAME="/opt/seagate/$PRODUCT_FAMILY/sspl"
RSYSLOG_CONF="/etc/rsyslog.d/0-iemfwd.conf"
RSYSLOG_SSPL_CONF="/etc/rsyslog.d/1-ssplfwd.conf"
LOGROTATE_CONF="/etc/logrotate.d/iem_messages"
LOGROTATE_SSPL_CONF="/etc/logrotate.d/sspl_logs"
SSPL_CONFIGURED="/var/$PRODUCT_FAMILY/sspl/sspl-configured"

usage() {
    cat << EOF
$SCRIPT_NAME [{config [-f] [-r <ssu|gw|cmu|vm>] [-c <true|false>] [-n <srvmod1,srvnode2>]}]
config options:
    -f  Force reinitialization. Do not prompt
    -r  Role to be configured on the current node
    -c  Cluster setup for rabbitmq required(yes|no)
    -n  Nodes added to rabbitmq cluster
EOF
    exit 1
}

config_sspl() {

    force=0
    role=
    rmq_cluster=true
    rmq_nodes=

    while getopts ":f:r:c:n:" OPTION; do
        case $OPTION in
            f )
                force=1
                ;;
            r )
                [ $# -lt 2 ] && usage
                role=$OPTARG
                [[ $ROLES =~ (^| )$role($| ) ]] || usage
                ;;
            c )
                rmq_cluster=$OPTARG
                nodes=`$SSPL_BASE_DIR/bin/consul kv get sspl/config/RABBITMQCLUSTER/cluster_nodes`
                num_nodes=`echo $nodes | tr "," " " | wc -w`
                [ "$num_nodes" == 2 ] && rmq_cluster=false
                ;;
            n )
                rmq_nodes=$OPTARG
                ;;
            * )
                usage
                ;;
        esac
    done

    [ $(id -u) -ne 0 ] && echo "Run this command with root privileges!!" &&
        exit 1
    [ -f $SSPL_CONF ] || {
        echo "Missing configuration!! Create $SSPL_CONF and rerun.";
        exit 1;
    }

    [ -f $SSPL_CONFIGURED ] && {
        [ "$force" = "1" ] && ans="y" || ans=;
        while [ "$ans" != "y" -a "$ans" != "n" ]; do
            echo -n "SSPL is already initialized. Reinitialize SSPL? [y/n]: ";
            read ans;
        done;
        [ "$ans" != "y" ] && exit 1;
        rm -f $SSPL_CONFIGURED;
    }

    # Get product
    product=$(sed -nr 's/^product=([^,]+)$/\1/p' $SSPL_CONF | head -1)
    [ -z "$product" ] && echo "No product specified in $SSPL_CONF" && exit 1

    enabled_products=$(python3.6 $DIR_NAME/bin/sspl_constants.py)
    [ -z "$enabled_products" ] && echo "No enabled products!" && exit 1
    [[ $enabled_products =~ (^| )$product($| ) ]] || {
        echo "Product '$product' is not in enabled products list: $enabled_products";
        exit 1;
    }

    # Configure role
    [ -z "$role" ] || sed -i "s/^setup=.*/setup=$role/g" $SSPL_CONF

    # Add sspl-ll user to required groups and sudoers file etc.
    echo "Initializing SSPL configuration ... "
    $DIR_NAME/bin/sspl_reinit $product || {
        reinit_err="$?";
        echo -n "$DIR_NAME/bin/sspl_reinit failed ";
        echo "with exit code ${reinit_err} for product $product";
        exit 1;
    }

    echo "SSPL configured successfully."
    mkdir -p $(dirname $SSPL_CONFIGURED)

    touch $SSPL_CONFIGURED

    # SSPL Log file configuration
    IFS='=' lfp=`grep ^sspl_log_file_path $SSPL_CONF`; logpath=( $lfp )
    SSPL_LOG_FILE_PATH=`echo ${logpath[1]}`

    [ ! -z "$SSPL_LOG_FILE_PATH" ] &&
    {
        sed -i "s|File=.*|File=\"$SSPL_LOG_FILE_PATH\")|g" $RSYSLOG_SSPL_CONF
        sed -i "1 s|^.*$|${SSPL_LOG_FILE_PATH}|g" $DIR_NAME/conf/etc/logrotate.d/sspl_logs
    }

    # IEM configuration
    # Configure log file path in Rsyslog and logrotate configuration file
    IFS='=' lfp=`grep ^log_file_path $SSPL_CONF`; datapath=( $lfp )
    LOG_FILE_PATH=`echo ${datapath[1]}`
    if [ -z "$LOG_FILE_PATH" ]
    then
        sed -i "s|File=.*|File=\/var/log/$PRODUCT_FAMILY/iem/iem_messages\"|g" $RSYSLOG_CONF
    else
        sed -i "s|File=.*|File=\"${LOG_FILE_PATH}\"|g" $RSYSLOG_CONF
        sed -i "1 s|^.*$|${LOG_FILE_PATH}|g" $DIR_NAME/conf/etc/logrotate.d/iem_messages
    fi
    cp $DIR_NAME/conf/etc/logrotate.d/iem_messages $LOGROTATE_CONF
    cp $DIR_NAME/conf/etc/logrotate.d/sspl_logs $LOGROTATE_SSPL_CONF

    # This rsyslog restart will happen after successful updation of rsyslog
    # conf file and before sspl starts. If at all this will be removed from
    # here, there will be a chance that SSPL intial logs will not be present in
    # "/var/log/<product>/sspl/sspl.log" file. So, initial logs needs to be collected from
    # "/var/log/messages"
    systemctl restart rsyslog

    # If consul is not running, exit
    CONSUL_PS=$(ps -aux | grep "sspl\/bin\/consul" | grep -v "grep" || true)
    if [ -z "$CONSUL_PS" ]; then
        echo "Consul is not running, exiting..";
        exit 1
    fi

}

cmd="config"
case $cmd in

    config )
        config_sspl $*
        ;;

    * )
        usage
        ;;
esac

# Updating RabbitMQ cluster nodes.
if [ "$product" == "ECS" ]; then
    [ "$rmq_cluster" == true ] && [ -n "$rmq_nodes" ] && $SSPL_BASE_DIR/bin/consul kv put sspl/config/RABBITMQCLUSTER/cluster_nodes $rmq_nodes
else
    out=$(rabbitmqctl cluster_status | grep running_nodes | cut -d '[' -f2 | cut -d ']' -f1 | sed 's/rabbit@//g' | sed 's/,/, /g')
    pout=$(echo $out | sed  "s/'//g")
    $SSPL_BASE_DIR/bin/consul kv put sspl/config/RABBITMQCLUSTER/cluster_nodes $pout
fi

# Updating build requested log level
log_level=`cat $DIR_NAME/conf/build-requested-loglevel | sed 's/ *$//'`
case $log_level in
    "DEBUG" | "INFO" | "WARNING" | "ERROR" | "CRITICAL")
        $SSPL_BASE_DIR/bin/consul kv put sspl/config/SYSTEM_INFORMATION/log_level $log_level;;
    "");;
    *)
        echo "Unexpected log level is requested, '$log_level'";;
esac
